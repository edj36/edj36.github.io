<h2 id="ocaml-clientserver">OCaml Client/Server</h2>
<p>Recently in a project for school, my team and I decided to build a server to complement a game we had been working on. The <a href="http://www.cs.cornell.edu/courses/cs3110/2016fa/index.php">course</a> is about functional programming and is taught in OCaml, thus we needed to use Ocaml to implement the client and server we wanted for our game. I certainly struggled at first finding useful examples or documentation for my needs, so here I am going to try and make my own. (These examples are built off of what I found in the documentation for <code>cohttp</code>).</p>
<h2 id="setup">Setup</h2>
<hr />
<p>First, install Ocaml. <a href="http://www.cs.cornell.edu/courses/cs3110/2016fa/install.html">Here</a> is how I did it.</p>
<p>Next, we need to install a couple of libraries, specifically <code>cohttp</code> and <code>lwt</code>. Those are the libaries we are going to use for networking (<code>cohttp</code>) and for threading (<code>lwt</code>). Get them from <code>opam</code> like this:</p>
<pre><code>$ opam install cohttp lwt</code></pre>
<p><code>cohttp</code> is a popular OCaml HTTP library, and <code>lwt</code> (Light Weight Threading) is exactly that, a light-weight thread library for Ocaml.</p>
<h2 id="client">Client</h2>
<hr />
<p>For my purposes, I needed my client to be able to send <code>GET</code> and <code>POST</code> requests. This is a bit tricky at first, but usually pretty simple once you have a general form for your requests.</p>
<p>You can dig through the <a href="http://github.com/mirage/ocaml-cohttp/">cohttp</a> repository to find their implementation of different requests, and to learn what you need to supply to send the requests. The repo also has a few useful examples, which I built upon for my purposes.</p>
<p>First we need to open the libraries we are using:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">open</span> Lwt
<span class="kw">open</span> Cohttp
<span class="kw">open</span> Cohttp_lwt_unix</code></pre></div>
<p>The <code>GET</code> request:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> get_request =
  <span class="kw">let</span> u = Uri.of_string <span class="st">&quot;host-name&quot;</span> <span class="kw">in</span>
  Client.get u &gt;&gt;= <span class="kw">fun</span> (resp, body) -&gt;
    <span class="kw">let</span> code = resp |&gt; Response.status |&gt; Code.code_of_status <span class="kw">in</span>
    <span class="dt">Printf</span>.printf <span class="st">&quot;Response code: %d</span><span class="ch">\n</span><span class="st">&quot;</span> code;
    body |&gt; Cohttp_lwt_body.to_string &gt;|= <span class="kw">fun</span> body -&gt;
      <span class="dt">Printf</span>.printf <span class="st">&quot;Body of length: %d</span><span class="ch">\n</span><span class="st">&quot;</span> (<span class="dt">String</span>.length body);
      body</code></pre></div>
<p>and the <code>POST</code> request:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> post_request str =
  <span class="kw">let</span> b = Cohttp_lwt_body.of_string str <span class="kw">in</span>
  <span class="kw">let</span> u = Uri.of_string <span class="st">&quot;host-name&quot;</span> <span class="kw">in</span>
  Client.post ~body: b u &gt;&gt;= <span class="kw">fun</span> (resp, body) -&gt;
    <span class="kw">let</span> code = resp |&gt; Response.status |&gt; Code.code_of_status <span class="kw">in</span>
    <span class="dt">Printf</span>.printf <span class="st">&quot;Response code: %d</span><span class="ch">\n</span><span class="st">&quot;</span> code;
    body |&gt; Cohttp_lwt_body.to_string &gt;|= <span class="kw">fun</span> body -&gt;
      <span class="dt">Printf</span>.printf <span class="st">&quot;Body of length: %d</span><span class="ch">\n</span><span class="st">&quot;</span> (<span class="dt">String</span>.length body);
      body</code></pre></div>
<p>Now to send either request:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="co">(* sends GET request *)</span>
Lwt.run get_request
<span class="co">(* sends POST request with given [str] as body *)</span>
Lwt.run (post_request str)</code></pre></div>
<p>For a while, I was lost as to why my request code seemed to compile fine, but nothing was ever sent. Calling <code>Lwt.run</code> is what actually triggers the functions execution, as it is asynchronous and needs to be scheduled.</p>
<h2 id="server">Server</h2>
<hr />
<p>Now for some backend stuff. It is pretty simple to get a server up and running, and I will show you the basics of that here. Above, in the client example, I was a bit vague and just gave some implementations of functions to send requests. Here, for the server, the code should run fine without any tweaks, however, I would still be sure to modify it to suit your needs.</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">open</span> Lwt
<span class="kw">open</span> Cohttp
<span class="kw">open</span> Cohttp_lwt_unix

<span class="kw">let</span> server =
<span class="kw">let</span> callback _conn req body =
  <span class="kw">let</span> uri = req |&gt; Request.uri |&gt; Uri.to_string <span class="kw">in</span>
  <span class="kw">let</span> meth = req |&gt; Request.meth |&gt; Code.string_of_method <span class="kw">in</span>
  <span class="kw">match</span> req |&gt; Request.meth <span class="kw">with</span>
  | `GET -&gt; body |&gt; Cohttp_lwt_body.to_string &gt;|= (<span class="kw">fun</span> body -&gt;
      (<span class="dt">print_endline</span> <span class="st">&quot;GET REQUEST RECEIVED&quot;</span>);
      body)
    &gt;&gt;= (<span class="kw">fun</span> body -&gt; (Server.respond_string ~status:`OK ~body ()))
  | `POST -&gt; body |&gt; Cohttp_lwt_body.to_string &gt;|= (<span class="kw">fun</span> body -&gt;
      (<span class="dt">print_endline</span> <span class="st">&quot;POST REQUEST RECEIVED&quot;</span>);
      body)
    &gt;&gt;= (<span class="kw">fun</span> body -&gt; (Server.respond_string ~status:`OK ~body ()))
  | _ -&gt; body |&gt; Cohttp_lwt_body.to_string &gt;|= (<span class="kw">fun</span> body -&gt;
      (<span class="dt">print_endline</span> <span class="st">&quot;UNEXPECTED REQUEST RECEIVED&quot;</span>);
      (<span class="st">&quot;ERROR&quot;</span>))
    &gt;&gt;= (<span class="kw">fun</span> body -&gt; (Server.respond_string ~status:`OK ~body ()))
<span class="kw">in</span>
Server.create ~mode:(`TCP (`Port <span class="dv">8080</span>)) (Server.make ~callback ())

<span class="kw">let</span> () = <span class="dt">ignore</span> (Lwt_main.run server)</code></pre></div>
<p>This code will create and run a server on <code>localhost:8080</code>, and the server can be &quot;killed&quot; with <code>CTRL C</code>. As you can see, its just a simple echo server, but it serves as a good starting point to building something more complex and exciting.</p>
<h2 id="usage">Usage</h2>
<hr />
<p>Once you have client and server implemented, its useful to develop a simple way to run them. I made a Makefile so that I would be able to run simple commands like <code>make server</code> in my terminal to compile and run the code. Makefile is as follows:</p>
<pre><code>client:
ocamlbuild -pkg cohttp.lwt client_example.native &amp;&amp; ./client_example.native

server:
ocamlbuild -pkg cohttp.lwt server_example.native &amp;&amp; ./server_example.native

clean:
ocamlbuild -clean</code></pre>
<p>If you plan on using a Makefile, be sure to change <code>client_example</code> and <code>server_example</code> to whatever you named your client and server files. Also, it is important to remember that the code snippets above aren't going to do much (if anything at all) if just copied and pasted into a <code>.ml</code> file and left to run. I will leave it up to you to build code around them for your client and server to actually do something useful :).</p>
<p>If anything above is wrong or unclear, or even if you just really like my work, let me know on <a href="http://twitter.com/EJ96">twitter</a>!!</p>
